<!-- Script-blok onderaan je HTML-pagina -->
<script>
  const firebaseConfig = {
    apiKey: "AIzaSyAg6WzWm4-jvYKaTSOsihHhb0lq7cGiO8o",
    authDomain: "hamofa-nozzles.firebaseapp.com",
    databaseURL: "https://hamofa-nozzles-default-rtdb.europe-west1.firebasedatabase.app",
    projectId: "hamofa-nozzles",
    storageBucket: "hamofa-nozzles.firebasestorage.app",
    messagingSenderId: "254337858286",
    appId: "1:254337858286:web:00bc75aaf9662016fd51ff",
    measurementId: "G-XSWW3X1E3D"
  };

  firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  let csvData = [];
  let adminLoggedIn = false;

  firebase.database().ref("nozzles").on("value", snapshot => {
    csvData = Object.values(snapshot.val() || {});
    console.log("üëâ Eerste item uit Firebase:", csvData[0]);
  });

  function showResults(matches) {
    const container = document.getElementById("resultsContainer");
    container.innerHTML = "";
    if (matches.length === 0) {
      container.innerHTML = "<p>Geen resultaten gevonden.</p>";
      return;
    }
    matches.forEach(match => {
      const div = document.createElement("div");
      div.className = "result";
      div.innerHTML = `
        <p><strong>Artikel Nr:</strong> ${match["Search Nr"] ?? "-"}</p>
        <p><strong>Nozzle Nr:</strong> ${match["NozzleNumber"] ?? "-"}</p>
        <p><strong>Verstuiver Houder:</strong> ${match["Holder Number"] ?? "-"}</p>
        <p><strong>Nominale druk:</strong> ${match["Bar Nom"] ?? "-"}</p>
        <p><strong>Minimale druk:</strong> ${match["Bar Min"] ?? "-"}</p>
        <p><strong>Maximale druk:</strong> ${match["Bar Max"] ?? "-"}</p>
      `;
      container.appendChild(div);
    });
  }

  function manualSearch() {
    const input = document.getElementById("manualInput").value.trim().toLowerCase().replace(/\s+/g, '');
    if (input === "") {
      document.getElementById("resultsContainer").innerHTML = "<p>‚ö†Ô∏è Vul iets in om te zoeken.</p>";
      return;
    }

    const matches = csvData.filter(item => {
      const clean = str => String(str || "").trim().toLowerCase().replace(/\s+/g, '');
      return (
        clean(item["EAN13"]) === input ||
        clean(item["NozzleNumber"]) === input ||
        clean(item["Search Nr"]) === input ||
        clean(item["Holder Number"]) === input
      );
    });

    showResults(matches);
  }

  let scanner = null;
  function startScanner() {
    Html5Qrcode.getCameras().then(devices => {
      const backCamera = devices.find(device => device.label.toLowerCase().includes("back") || device.label.toLowerCase().includes("rear")) || devices[0];
      scanner = new Html5Qrcode("reader", { rememberLastUsedCamera: true });
      scanner.start(
        { deviceId: { exact: backCamera.id } },
        { fps: 10, qrbox: { width: 400, height: 250 }, aspectRatio: 1.777, disableFlip: true },
        decodedText => {
          scanner.stop().then(() => {
            scanner.clear();
            scanner = null;
            document.getElementById("closeScannerBtn").style.display = "none";
          });
          const code = decodedText.trim();
          document.getElementById("resultsContainer").innerHTML = `<p>üì¶ Gescand: <strong>${code}</strong></p>`;
          const matches = csvData.filter(item => String(item["EAN13"]).trim() === code);
          showResults(matches);
        },
        error => { console.warn("Scan fout:", error); }
      ).then(() => {
        document.getElementById("closeScannerBtn").style.display = "inline-block";
      }).catch(err => {
        console.error("Start scanner mislukt:", err);
        scanner = null;
      });
    }).catch(err => console.error("Camera‚Äôs niet beschikbaar:", err));
  }

  function closeScanner() {
    if (scanner !== null) {
      scanner.stop().then(() => {
        scanner.clear();
        scanner = null;
        document.getElementById("closeScannerBtn").style.display = "none";
      });
    }
  }

  document.getElementById("adminAccess").addEventListener("click", () => {
    document.getElementById("adminOverlay").style.display = "block";
    document.getElementById("adminPassword").value = "";
    document.getElementById("loginForm").style.display = "block";
    document.getElementById("addForm").style.display = "none";
    document.getElementById("loginMessage").innerText = "";
  });

  function checkPassword() {
    const pwd = document.getElementById("adminPassword").value;
    if (pwd === "kris1989") {
      adminLoggedIn = true;
      document.getElementById("loginForm").style.display = "none";
      document.getElementById("addForm").style.display = "block";
    } else {
      adminLoggedIn = false;
      document.getElementById("loginMessage").innerText = "‚ùå Verkeerd wachtwoord!";
    }
  }

  function closeAdmin() {
    document.getElementById("adminOverlay").style.display = "none";
  }

  function addNewEntry() {
    if (!adminLoggedIn) {
      alert("‚ùå Je bent niet ingelogd als admin. Probeer opnieuw.");
      return;
    }

    const newEntry = {
      "Search Nr": document.getElementById("newSearchNr").value.trim(),
      "NozzleNumber": document.getElementById("newNozzle").value.trim(),
      "Holder Number": document.getElementById("newHolder").value.trim(),
      "Bar Nom": parseInt(document.getElementById("newBarNom").value.trim()) || null,
      "Bar Min": parseInt(document.getElementById("newBarMin").value.trim()) || null,
      "Bar Max": parseInt(document.getElementById("newBarMax").value.trim()) || null,
      "EAN13": document.getElementById("newEAN").value.trim()
    };

    console.log("üì¶ Nieuwe entry klaar om op te slaan:", newEntry);

    firebase.database().ref("nozzles").push(newEntry)
      .then(() => {
        alert("‚úÖ Toegevoegd!");
        closeAdmin();
        csvData.push(newEntry);
      })
      .catch(err => {
        console.error("‚ùå Fout bij toevoegen:", err);
        alert("‚ùå Fout bij toevoegen:\n" + err.message);
      });
  }
</script>
